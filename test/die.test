#!/usr/bin/env bats
# -*- mode: sh -*-

TEST="cyl3d"

@test "[$TEST] verify solution terminates early with presence of DIE file" {
    RUNFILE=input.2iters.cyl
    RUNFILE_MOD=${RUNFILE}.mod
    SOLFILE_BASE=restart_output.sol

    rm -f  restart_output.sol*.h5
    rm -f  partition.*.h5
    rm -f  $RUNFILE_MOD
    sed  's/NMAX 2/NMAX 30/' $RUNFILE > $RUNFILE_MOD
    echo "EXIT_CHECK_FREQUENCY 10" >> $RUNFILE_MOD

    test -x die.sh
    run ./die.sh $RUNFILE_MOD
    [[ "${status}" -eq 11 ]]

    test -e DIE
    test -s restart_output.sol.0.h5
    test -s restart_output.sol.1.h5

    run h5dump  -a iteration  ${SOLFILE_BASE}.0.h5
    [ "${lines[5]}" = "   (0): 10" ]

    run h5dump  -a iteration  ${SOLFILE_BASE}.1.h5
    [ "${lines[5]}" = "   (0): 10" ]
}
